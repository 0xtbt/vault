---
layout: docs
page_title: Seal/Unseal
sidebar_title: Seal/Unseal
description: >-
  A Vault must be unsealed before it can access its data. Likewise, it can be
  sealed to lock it down.
---

# Seal/Unseal

When a Vault server is started, it starts in a _sealed_ state. In this
state, Vault is configured to know where and how to access the physical
storage, but doesn't know how to decrypt any of it.

_Unsealing_ is the process of constructing the master key necessary to
read the decryption key to decrypt the data, allowing access to the Vault.

Prior to unsealing, almost no operations are possible with Vault. For
example authentication, managing the mount tables, etc. are all not possible.
The only possible operations are to unseal the Vault and check the status
of the unseal.

## Why?

The data stored by Vault is stored encrypted. Vault needs the
_encryption key_ in order to decrypt the data. The encryption key is
also stored with the data, but encrypted with another encryption key
known as the _master key_. The master key isn't stored anywhere.

Therefore, to decrypt the data, Vault must decrypt the encryption key
which requires the master key. Unsealing is the process of reconstructing
this master key.

Instead of distributing this master key as a single key to an operator,
Vault uses an algorithm known as
[Shamir's Secret Sharing](https://en.wikipedia.org/wiki/Shamir%27s_Secret_Sharing)
to split the key into shards. A certain threshold of shards is required to
reconstruct the master key.

This is the _unseal_ process: the shards are added one at a time (in any
order) until enough shards are present to reconstruct the key and
decrypt the data.

## Unsealing

The unseal process is done by running `vault operator unseal` or via the API.
This process is stateful: each key can be entered via multiple mechanisms
on multiple computers and it will work. This allows each shard of the master
key to be on a distinct machine for better security.

Once a Vault is unsealed, it remains unsealed until one of two things happens:

1. It is resealed via the API (see below).

2. The server is restarted.

-> **Note:** Unsealing makes the process of automating a Vault install
difficult. Automated tools can easily install, configure, and start Vault,
but unsealing it is a very manual process. We have plans in the future to
make it easier. For the time being, the best method is to manually unseal
multiple Vault servers in [HA mode](/docs/concepts/ha). Use a tool such
as Consul to make sure you only query Vault servers that are unsealed.

## Sealing

There is also an API to seal the Vault. This will throw away the master
key and require another unseal process to restore it. Sealing only requires
a single operator with root privileges.

This way, if there is a detected intrusion, the Vault data can be locked
quickly to try to minimize damages. It can't be accessed again without
access to the master key shards.

## Auto Unseal

Auto Unseal was developed to aid in reducing the operational complexity of
keeping the master key secure. This feature delegates the responsibility of
securing the master key from users to a trusted device or service. Instead of
only constructing the key in memory, the master key is encrypted with one of
these services or devices and then stored in the storage backend allowing Vault
to decrypt the master key at startup and unseal automatically.

When using Auto Unseal there are certain operations in Vault that still
require a quorum of users to perform an operation such as generating a root token.
During the initialization process, a set of Shamir keys are generated that are called
Recovery Keys and are used for these operations.

For a list of examples and supported providers, please see the
[seal documentation](/docs/configuration/seal).

## Recovery Key Rekeying

During Auto Seal initialization process, a set of Shamir keys called Recovery Keys are
generated which are used for operations that still require a quorum of users.

Recovery Keys can be rekeyed to change the number of shares or thresholds. When using the
Vault CLI, this is performed by using the `-target=recovery` flag to `vault operator rekey`.

## Seal Migration

The seal can be migrated from Shamir Seal to KMS Seal, KMS Seal to Shamir Seal
and KMS Seal to another KMS Seal.

~> **NOTE**: The seal migration process cannot be performed without downtime.
Due to the intricate technical underpinnings of the seal feature, it is at this
point not possible to perform seal migration without bringing the whole cluster
down. We understand that it can be painful for many users to bring the full
cluster down. But, we believe that switching seals is a very rare event and
hence hope for the downtime to be considered as an acceptable trade-off.

~> **NOTE**: The migration operation will require both seals to be available
during the migration. For example, a migration from a KMS seal to Shamir will
require that the KMS key be accessible during the migration.

### Migration From Shamir Seal to KMS Seal

#### When **not** using Integrated Storage

1. Take your server cluster offline.

2. Add the desired KMS [seal block](/docs/configuration/seal) to the
configuration file of one of the nodes.

3. Bring this one node back up and run the unseal command by supplying the
`-migrate` flag for each unseal key. This node will be the active node and
completes the seal migration process. The Shamir unseal keys supplied here will
be migrated as the recovery keys for the KMS seal.

4. Standby nodes can join the active node's cluster using the new seal blocks.
Note that by the time standby nodes join the cluster, the migration process is
already complete. Hence, the standby nodes will be auto-unsealed through the KMS
key and will not require an explicit unseal command.

#### When using Integrated Storage

Integrated Storage is implemented using the [Raft Consensus Algorithm][raft] and
would require a quorum of nodes to be fully operational.

1. Take your server cluster offline.

2. Add the desired KMS [seal block](/docs/configuration/seal) to the
configuration files of quorum number of nodes in the cluster.

3. Bring the quorum number of nodes back up. On each of these nodes, run the
unseal command by supplying the `-migrate` flag for each unseal key. The Shamir
unseal keys supplied here will be migrated as the recovery keys for the KMS
seal. Raft protocol will then elect a leader node and this leader node will
complete the seal migration process. If a leadership change happens after the
seal migration is complete, the new leader will detect the fact and does not
repeat the seal migration.

4. Any new node joining to the cluster at this point will not require manual
running of the unseal command. The join will ensure auto-unsealing of the node
through KMS key.

### Migration From KMS Seal to Shamir Seal

~> **NOTE**: Migration to Shamir seal is not currently supported when using
Vault Enterprise. We plan to support this officially in a future release.

#### When **not** using Integrated Storage

1. Take your server cluster offline.

2. Add `disabled = "true"` to the old KMS [seal block](/docs/configuration/seal)
in the config file of one of the nodes. Shamir seal does not require an explicit
seal block.

3. Bring this one node back up and run the unseal command using the recovery
keys of the KMS seal along with supplying the `-migrate` flag for each recovery
key. This node will be the active node and completes the seal migration process.
The recovery keys supplied here will be migrated as the unseal keys for the
Shamir seal.

4. Standby nodes can join the active node's cluster without the KMS seal blocks.
Note that by the time standby nodes join the cluster, the migration process is
already complete. Hence, the standby nodes will not require the `-migrate` flag
to be unsealed.

#### When using Integrated Storage

Integrated Storage is implemented using the [Raft Consensus Algorithm][raft] and
would require a quorum of nodes to be fully operational.

1. Take your server cluster offline.

2. Add `disabled = "true"` to the old KMS [seal block](/docs/configuration/seal)
to the configuration files of quorum number of nodes in the cluster. Shamir seal
does not require an explicit seal block.

3. Bring the quorum number of nodes back up. On each of these nodes, run the
unseal command using the recovery keys of the KMS seal along with supplying the
`-migrate` flag for each recovery key. The recovery keys supplied here will be
migrated as the unseal keys for the Shamir seal. Raft protocol will then elect a
leader node and this leader node will complete the seal migration process. If a
leadership change happens after the seal migration is complete, the new leader
will detect the fact and does not repeat the seal migration.

### Migration From Auto Unseal to Auto Unseal

~> **NOTE**: Migration between same Auto Unseal types is not currently
supported. We plan to support this officially in a future release.

#### When **not** using Integrated Storage

1. Take your server cluster offline.

2. Add `disabled = "true"` to the old KMS [seal block](/docs/configuration/seal)
and add the desired new seal block in the config file of one of the nodes.

3. Bring this one node back up and run the unseal command using the Recovery
Keys of the old KMS seal along with supplying the `-migrate` flat for each
recovery key. This node will be the active node and completes the seal migration
process. The recovery keys of the old KMS seal supplied here will be migrated as
the recovery keys for the new KMS seal.

4. Standby nodes can join the active node's cluster without the old KMS seal
blocks. Note that by the time standby nodes join the cluster, the migration
process is already complete. Hence, the standby nodes will be auto-unsealed
through the new KMS key.

#### When using Integrated Storage

Integrated Storage is implemented using the [Raft Consensus Algorithm][raft] and
would require a quorum of nodes to be fully operational.

1. Take your server cluster offline.

2. Add `disabled = "true"` to the old KMS [seal block](/docs/configuration/seal)
and add the desired new seal block in the config file of quorum number of nodes
in the cluster.

3. Bring the quorum number of nodes back up. On each of these nodes, run the
unseal command using the recovery keys of the old KMS seal along with supplying
the `-migrate` flat for each recovery key. The recovery keys of the old KMS seal
supplied here will be migrated as the recovery keys for the new KMS seal. Raft
protocol will then elect a leader node and this leader node will complete the
seal migration process. If a leadership change happens after the seal migration
is complete, the new leader will detect the fact and does not repeat the seal
migration.

4. Any new node joining the cluster at this point will not require the old KMS
seal blocks. The join will ensure auto-unsealing of the nodes through the new
KMS key.

[raft]: https://raft.github.io/ 'The Raft Consensus Algorithm'
